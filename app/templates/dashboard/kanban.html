{% extends 'base.html' %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="section-heading">Канбан-доска кандидатов</h1>
    
    <!-- Фильтры -->
    <div class="card mb-4">
        <div class="card-header bg-white">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h5 class="mb-0">Фильтры</h5>
                </div>
                <div class="col-md-8">
                    <form method="get" class="row g-2 align-items-center">
                        <div class="col-md-6">
                            <label for="vacancy_filter" class="form-label mb-0 small">Вакансия</label>
                            <select name="vacancy_id" id="vacancy_filter" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="">Все вакансии</option>
                                {% for vacancy in vacancies %}
                                <option value="{{ vacancy.id }}" {% if vacancy_id == vacancy.id %}selected{% endif %}>{{ vacancy.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Канбан-доска -->
    <div class="kanban-board mb-4">
        <div class="row g-3" id="kanban-container">
            {% for stage_id, stage in kanban_data.items() %}
            <div class="col-md-4 col-lg-3 col-xl-3 kanban-column" data-stage-id="{{ stage_id }}">
                <div class="card kanban-column-card h-100">
                    <div class="card-header kanban-column-header" style="background-color: {{ stage.color or '#6c757d' }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0 text-white">{{ stage.name }}</h5>
                            <span class="badge bg-white text-dark">{{ stage.candidates|length }}</span>
                        </div>
                        <small class="text-white">{{ stage.description }}</small>
                    </div>
                    <div class="card-body p-2 kanban-column-body" id="stage-{{ stage_id }}">
                        {% for candidate in stage.candidates %}
                        <div class="card kanban-item mb-2" id="candidate-{{ candidate.id }}" data-candidate-id="{{ candidate.id }}">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between">
                                    <h6 class="kanban-card-title mb-1">{{ candidate.name }}</h6>
                                    {% if candidate.ai_match_percent is not none %}
                                    <span class="badge {% if candidate.ai_match_percent >= 70 %}bg-success{% elif candidate.ai_match_percent >= 40 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ candidate.ai_match_percent }}%
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="small text-muted mb-2">{{ candidate.vacancy_title }}</div>
                                <div class="kanban-card-details">
                                    <div class="row g-2">
                                        <div class="col-12">
                                            <div class="d-flex align-items-center small">
                                                <i class="fas fa-envelope me-2 text-secondary"></i>
                                                <div class="text-truncate">{{ candidate.email or "Нет Email" }}</div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="d-flex align-items-center small">
                                                <i class="fas fa-phone me-2 text-secondary"></i>
                                                <div>{{ candidate.phone or "Нет телефона" }}</div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="d-flex align-items-center small text-muted">
                                                <i class="fas fa-clock me-2"></i>
                                                <div>{{ candidate.created_at.strftime('%d.%m.%Y') }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="kanban-actions mt-2">
                                    <div class="d-flex justify-content-end">
                                        <a href="{{ url_for('candidates.view', id=candidate.id) }}" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-secondary ms-2 add-comment-btn" data-candidate-id="{{ candidate.id }}">
                                            <i class="fas fa-comment-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="kanban-empty-state text-center p-4">
                            <i class="fas fa-inbox text-muted mb-2" style="font-size: 24px;"></i>
                            <p class="text-muted mb-0 small">Нет кандидатов на этом этапе</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Модальное окно для добавления комментария -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel">Добавить комментарий</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="candidate_id_for_comment">
                <textarea class="form-control" id="candidate_comment" rows="4" placeholder="Введите комментарий"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveCommentBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Стили для канбана -->
<style>
    .kanban-board {
        overflow-x: auto;
    }
    
    .kanban-column {
        min-width: 320px;
    }
    
    .kanban-column-card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .kanban-column-header {
        border-bottom: none;
        padding: 0.75rem 1rem;
    }
    
    .kanban-column-body {
        height: calc(100vh - 280px);
        overflow-y: auto;
        padding: 0.75rem;
    }
    
    .kanban-item {
        transition: all 0.3s ease;
        cursor: grab;
        border-left: 5px solid #6c757d;
    }
    
    .kanban-item:active {
        cursor: grabbing;
    }
    
    .kanban-item:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .gu-mirror {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        cursor: grabbing !important;
    }
    
    .gu-transit {
        opacity: 0.4 !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Dragula JS - библиотека для drag-and-drop -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.3/dragula.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.3/dragula.min.css" rel="stylesheet">
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CSRF-токен для AJAX-запросов
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Получаем все столбцы канбана
    const columns = document.querySelectorAll('.kanban-column-body');
    
    // Инициализируем Dragula
    const drake = dragula(Array.from(columns), {
        moves: function(el, container, handle) {
            return true; // Разрешаем перетаскивать все элементы
        },
        accepts: function(el, target, source, sibling) {
            return true; // Разрешаем перемещать во все столбцы
        },
        direction: 'vertical'
    });
    
    // Обработчик события завершения перетаскивания
    drake.on('drop', function(el, target, source, sibling) {
        const candidateId = el.getAttribute('data-candidate-id');
        const stageId = target.closest('.kanban-column').getAttribute('data-stage-id');
        
        // Показываем модальное окно для комментария
        $('#candidate_id_for_comment').val(candidateId);
        $('#candidate_stage_id').val(stageId);
        $('#commentModal').modal('show');
    });
    
    // Добавление комментария и обновление статуса
    document.getElementById('saveCommentBtn').addEventListener('click', function() {
        const candidateId = document.getElementById('candidate_id_for_comment').value;
        const comment = document.getElementById('candidate_comment').value.trim();
        const stageId = $(`#candidate-${candidateId}`).closest('.kanban-column').attr('data-stage-id');
        
        // Отправляем данные на сервер
        updateCandidateStatus(candidateId, stageId, comment);
        
        // Закрываем модальное окно
        $('#commentModal').modal('hide');
        document.getElementById('candidate_comment').value = '';
    });
    
    // Обработчик нажатия на кнопку комментария
    document.querySelectorAll('.add-comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const candidateId = this.getAttribute('data-candidate-id');
            document.getElementById('candidate_id_for_comment').value = candidateId;
            $('#commentModal').modal('show');
        });
    });
    
    // Функция для обновления статуса кандидата
    function updateCandidateStatus(candidateId, stageId, comment) {
        fetch('/dashboard/api/kanban/update-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken
            },
            body: JSON.stringify({
                candidate_id: candidateId,
                status_id: stageId,
                comment: comment
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Обновляем UI
                updateCandidateUI(candidateId, stageId, data);
                showToast('Статус успешно обновлен', 'success');
            } else {
                // Отображаем ошибку
                showToast(data.message, 'error');
                
                // Возвращаем карточку обратно в исходный столбец
                drake.cancel(true);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Произошла ошибка при обновлении статуса', 'error');
            drake.cancel(true);
        });
    }
    
    // Функция обновления UI после обновления статуса
    function updateCandidateUI(candidateId, stageId, data) {
        // Обновление UI при необходимости
    }
    
    // Функция для отображения уведомлений
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0 position-fixed top-0 end-0 m-3`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        document.body.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
});
</script>
{% endblock %} 