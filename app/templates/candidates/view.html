{% extends 'base.html' %}

{% block content %}
<div class="container-fluid px-4">
    <!-- CSRF-токен для AJAX-запросов в скрытой форме -->
    <form id="csrf-form" style="display: none;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
    </form>
    
    <div class="row mb-4">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% if current_user.role == 'admin' %}{{ url_for('dashboard.index') }}{% else %}{{ url_for('dashboard.hr_dashboard') }}{% endif %}">Панель управления</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('candidates.index') }}">Кандидаты</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ candidate.full_name }}</li>
                </ol>
            </nav>
            <h1 class="section-heading">Кандидат: {{ candidate.full_name }}</h1>
            <p class="text-muted">Вакансия: <a href="{{ url_for('vacancies.view', id=candidate.vacancy_id) }}">{{ candidate.vacancy.title }}</a> | Дата отклика: {{ candidate.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
        </div>
    </div>
    
    <div class="col-12 mb-4">
        <!-- Левая колонка: основная информация -->
        <div class="col-md-12 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h4 class="mb-0">Основная информация</h4>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">ФИО:</dt>
                        <dd class="col-sm-8">{{ candidate.full_name }}</dd>
                        
                        <dt class="col-sm-4">Email:</dt>
                        <dd class="col-sm-8">{{ candidate.email }}</dd>
                        
                        <dt class="col-sm-4">Телефон:</dt>
                        <dd class="col-sm-8">{{ candidate.phone }}</dd>
                        
                        <dt class="col-sm-4">Этап отбора:</dt>
                        <dd class="col-sm-8">
                            <span id="statusBadge" class="badge rounded-pill" 
                                  style="background-color: {{ candidate.stage_id.color if candicard-bodydate.selection_stage else 'secondary' }}">
                                {{ candidate.stage_id.name if candidate.selection_stage else 'Заявка подана' }}
                            </span>
                        </dd>
                        
                        {% if candidate.interview_date %}
                        <dt class="col-sm-4">Дата интервью:</dt>
                        <dd class="col-sm-8">{{ candidate.interview_date.strftime('%d.%m.%Y %H:%M') }}</dd>
                        {% endif %}
                        
                        <dt class="col-sm-4">Трекинг-код:</dt>
                        <dd class="col-sm-8">{{ candidate.tracking_code }}</dd>
                    </dl>
                    
                    <!-- Форма изменения этапа отбора -->
                    <div class="mt-4">
                        <h5>Изменить этап отбора</h5>
                        <form method="POST" action="{{ url_for('candidates.change_status', id=candidate.id) }}" class="row g-3">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="col-md-6">
                                <label for="stage-select" class="form-label">Этап отбора</label>
                                <select name="stage_id" class="form-select" id="stage-select">
                                    {% for stage in stages %}
                                    <option value="{{ stage.id }}" {% if candidate.stage_id == stage.id %}selected{% endif %}>{{ stage.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Выбор причины отклонения (показывается только при статусе "Отклонен") -->
                            <div class="col-md-6" id="rejection-reason-container" style="display: none;">
                                <label for="rejection_reason" class="form-label">Причина отклонения</label>
                                <select class="form-select" id="rejection_reason" name="rejection_reason">
                                    <option value="">Выберите причину отклонения</option>
                                    {% for reason in rejection_reasons %}
                                    <option value="{{ reason.id }}" {% if candidate.id_c_rejection_reason == reason.id %}selected{% endif %}>
                                        {{ reason.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Обновить этап отбора</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Отображение этапов отбора вакансии -->
                    <div class="mt-4">
                        <h5>Этапы отбора для вакансии</h5>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div><strong>Новая заявка</strong></div>
                                {% if candidate.stage_id == 0 %}
                                <span class="badge bg-primary rounded-pill">Текущий этап</span>
                                {% endif %}
                            </li>
                            
                            {% if candidate.vacancy and candidate.vacancy.selection_stages_json %}
                                {% for stage in candidate.vacancy.selection_stages_json %}
                                    {% set stage_index = loop.index %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ stage.name }}</strong>
                                            <p class="mb-0 small text-muted">{{ stage.description }}</p>
                                        </div>
                                        {% if candidate.stage_id == stage_index %}
                                        <span class="badge bg-primary rounded-pill">Текущий этап</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            {% else %}
                                <li class="list-group-item">
                                    <div class="text-muted">Для этой вакансии не настроены индивидуальные этапы отбора</div>
                                </li>
                            {% endif %}
                            
                            <!-- Финальные статусы всегда показываем -->
                            <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-success">
                                <div><strong>Принят на работу</strong></div>
                                {% if candidate.stage_id == 4 %}
                                <span class="badge bg-primary rounded-pill">Текущий этап</span>
                                {% endif %}
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center list-group-item-danger">
                                <div><strong>Отклонен</strong></div>
                                {% if candidate.stage_id == 5 %}
                                <span class="badge bg-primary rounded-pill">Текущий этап</span>
                                {% endif %}
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Форма добавления комментария -->
                    <div class="mt-4">
                        <h5>Комментарий HR</h5>
                        <form method="POST" action="{{ url_for('candidates.add_comment', id=candidate.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="mb-3">
                                <textarea name="comment" class="form-control" rows="3" placeholder="Добавьте ваш комментарий">{{ candidate.hr_comment }}</textarea>
                            </div>
                            <button type="submit" class="btn btn-outline-primary">Сохранить комментарий</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Правая колонка: AI-анализ -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-robot me-2"></i>AI-анализ соответствия
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Индикатор загрузки для AI-анализа -->
                    <div id="aiLoadingSpinner" class="text-center my-3 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Выполняется AI-анализ кандидата...</p>
                    </div>
                    
                    {% if candidate.ai_match_percent is not none %}
                    <div class="ai-analysis">
                        <!-- Кнопка повторного анализа -->
                        <div class="text-end mb-3">
                            <button id="rerunAnalysisBtn" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-sync-alt me-1"></i>Повторный анализ
                            </button>
                        </div>
                        
                        <!-- Общая оценка - новый дизайн в стиле верификации Instagram -->
                        <div class="ai-score-container">
                            <h5 class="mb-3">Общая оценка соответствия:</h5>
                            
                            {% set score_class = 'high' if candidate.ai_match_percent >= 70 else ('medium' if candidate.ai_match_percent >= 40 else 'low') %}
                            {% set rating_text = 'Высокое соответствие' if candidate.ai_match_percent >= 70 else ('Среднее соответствие' if candidate.ai_match_percent >= 40 else 'Низкое соответствие') %}
                            {% set rating_icon = 'fa-check-circle' if candidate.ai_match_percent >= 70 else ('fa-exclamation-circle' if candidate.ai_match_percent >= 40 else 'fa-times-circle') %}
                            
                            <div class="ai-verification-badge {{ score_class }}">
                                <div class="ai-verification-icon {{ score_class }}">
                                    <i class="fas {{ rating_icon }}"></i>
                                </div>
                                <div class="ai-verification-content">
                                    <div class="ai-verification-title">{{ rating_text }}</div>
                                    <div class="ai-verification-score {{ score_class }}">{{ candidate.ai_match_percent }}%</div>
                                    <div class="ai-verification-label">Оценка соответствия вакансии</div>
                                </div>
                            </div>
                        </div>

                        <!-- Сильные и слабые стороны -->
                        <div class="ai-pros-cons">
                            <!-- Сильные стороны -->
                            <div class="ai-pros-cons-card">
                                <div class="ai-pros-cons-header pros">
                                        <h5 class="mb-0">
                                            <i class="fas fa-plus-circle me-2"></i>Сильные стороны
                                        </h5>
                                    </div>
                                <div class="ai-pros-cons-body">
                                    {% if candidate.ai_pros and candidate.ai_pros|length > 0 and (candidate.ai_pros[0]|trim) %}
                                        <ul class="ai-pros-cons-list">
                                            {% if candidate.ai_pros is string %}
                                                <li class="ai-pros-cons-item pros">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span>{{ candidate.ai_pros }}</span>
                                                </li>
                                            {% else %}
                                                {% for pro in candidate.ai_pros %}
                                                    {% if pro|trim %}
                                                        <li class="ai-pros-cons-item pros">
                                                            <i class="fas fa-check-circle"></i>
                                                            <span>{{ pro }}</span>
                                                    </li>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            </ul>
                                        {% else %}
                                        <p class="ai-no-data">Сильных сторон не выявлено</p>
                                        {% endif %}
                                </div>
                            </div>

                            <!-- Слабые стороны -->
                            <div class="ai-pros-cons-card">
                                <div class="ai-pros-cons-header cons">
                                        <h5 class="mb-0">
                                            <i class="fas fa-minus-circle me-2"></i>Слабые стороны
                                        </h5>
                                    </div>
                                <div class="ai-pros-cons-body">
                                    {% if candidate.ai_cons and candidate.ai_cons|length > 0 and (candidate.ai_cons[0]|trim) %}
                                        <ul class="ai-pros-cons-list">
                                            {% if candidate.ai_cons is string %}
                                                <li class="ai-pros-cons-item cons">
                                                    <i class="fas fa-times-circle"></i>
                                                    <span>{{ candidate.ai_cons }}</span>
                                                </li>
                                            {% else %}
                                                {% for con in candidate.ai_cons %}
                                                    {% if con|trim %}
                                                        <li class="ai-pros-cons-item cons">
                                                            <i class="fas fa-times-circle"></i>
                                                            <span>{{ con }}</span>
                                                    </li>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            </ul>
                                        {% else %}
                                        <p class="ai-no-data">Слабых сторон не выявлено</p>
                                        {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Несоответствия данных и качество ответов -->
                        <div class="ai-data-consistency mt-4">
                            <h5 class="mb-3">Проверка данных и качества ответов</h5>
                            
                            <!-- Качество ответов -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0 text-secondary"><i class="fas fa-comment-alt me-2"></i>Качество ответов 
                                        <span class="badge {% if candidate.ai_answer_quality.overall_quality and ('высок' in candidate.ai_answer_quality.overall_quality|lower or 'хорош' in candidate.ai_answer_quality.overall_quality|lower) %}bg-success{% elif candidate.ai_answer_quality.overall_quality and ('средн' in candidate.ai_answer_quality.overall_quality|lower) %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                            {{ candidate.ai_answer_quality.overall_quality.split(':')[0] if candidate.ai_answer_quality.overall_quality and ':' in candidate.ai_answer_quality.overall_quality else candidate.ai_answer_quality.overall_quality }}
                                        </span>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="col-md-12">
                                        <div class="col-md-12">
                                            <dl class="row mb-0">
                                                <dt class="col-sm-6">Общее качество:</dt>
                                                <dd class="col-sm-6">
                                                    <p>{{ candidate.ai_answer_quality.overall_quality}}</p>
                                                </dd>
                                            </dl>
                                        </div>
                                        <div class="col-md-12">
                                            <dl class="row mb-0">
                                                <dt class="col-sm-6">Развернутость:</dt>
                                                <dd class="col-sm-6">{{ candidate.ai_answer_quality.verbosity }}</dd>
                                                
                                                <dt class="col-sm-6">Релевантность:</dt>
                                                <dd class="col-sm-6">{{ candidate.ai_answer_quality.relevance }}</dd>

                                                <dt class="col-sm-6">Грамотность:</dt>
                                                <dd class="col-sm-6">{{ candidate.ai_answer_quality.grammar }}</dd>
                                                
                                                <dt class="col-sm-6">Структура:</dt>
                                                <dd class="col-sm-6">{{ candidate.ai_answer_quality.structure }}</dd>
                                                
                                            </dl>
                                        </div>
                                    </div>
                                    
                                    {% if candidate.ai_data_completeness and candidate.ai_data_completeness.low_quality_answers and candidate.ai_data_completeness.answer_quality_issues %}
                                    <div class="mt-3">
                                        <h6>Проблемы с качеством ответов:</h6>
                                        <ul>
                                            {% for issue in candidate.ai_data_completeness.answer_quality_issues %}
                                            <li>{{ issue }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Детализация по категориям -->
                        <div class="ai-categories">
                            {% if candidate.ai_analysis_data and candidate.ai_analysis_data.scores and candidate.ai_analysis_data.score_comments %}
                            {% set score_mapping = {
                                'location': {'name': 'Локация', 'icon': 'fa-map-marker-alt'},
                                'experience': {'name': 'Опыт работы', 'icon': 'fa-briefcase'},
                                'tech_skills': {'name': 'Технические навыки', 'icon': 'fa-cogs'},
                                'education': {'name': 'Образование', 'icon': 'fa-graduation-cap'},
                                'soft_skills': {'name': 'Soft Skills', 'icon': 'fa-users'},
                                'motivation_and_values': {'name': 'Мотивация', 'icon': 'fa-bolt'},
                                'employment_stability': {'name': 'Стабильность', 'icon': 'fa-chart-line'},
                                'experience_relevance': {'name': 'Релевантность опыта', 'icon': 'fa-check-circle'},
                                'language_skills': {'name': 'Языки', 'icon': 'fa-language'},
                                'salary_expectations': {'name': 'Зарплатные ожидания', 'icon': 'fa-money-bill-wave'}
                            } %}
                            
                            {% for key, score in candidate.ai_analysis_data.scores.items() %}
                                {% if score_mapping[key] %}
                                {% set icon_class = 'green' if score >= 70 else ('yellow' if score >= 40 else 'red') %}
                                <div class="ai-category">
                                    <span class="ai-category-icon {{ icon_class }}"><i class="fas {{ score_mapping[key].icon }}"></i></span>
                                    <div class="ai-category-content">
                                        <div class="ai-category-header-row">
                                            <span class="ai-category-name text-secondary">{{ score_mapping[key].name }}</span>
                                            <span class="ai-category-score-badge {% if score >= 70 %}green{% elif score >= 40 %}yellow{% else %}red{% endif %}">{{ score }}/100</span>
                                        </div>
                                        <p class="ai-category-comment text-secondary">{{ candidate.ai_analysis_data.score_comments[key] }}</p>
                                                    </div>
                                                </div>
                                {% endif %}
                            {% endfor %}
                            {% else %}
                            {% set categories = [
                                {'icon': 'fa-map-marker-alt', 'name': 'Локация', 'score': candidate.ai_score_location|default(0), 'comment': candidate.ai_score_comments_location|default('Нет данных')},
                                {'icon': 'fa-briefcase', 'name': 'Опыт работы', 'score': candidate.ai_score_experience|default(0), 'comment': candidate.ai_score_comments_experience|default('Нет данных')},
                                {'icon': 'fa-cogs', 'name': 'Технические навыки', 'score': candidate.ai_score_tech|default(0), 'comment': candidate.ai_score_comments_tech|default('Нет данных')},
                                {'icon': 'fa-graduation-cap', 'name': 'Образование', 'score': candidate.ai_score_education|default(0), 'comment': candidate.ai_score_comments_education|default('Нет данных')},
                                {'icon': 'fa-users', 'name': 'Soft Skills', 'score': candidate.ai_score_soft|default(0), 'comment': candidate.ai_score_comments_soft|default('Нет данных')},
                                {'icon': 'fa-bolt', 'name': 'Мотивация', 'score': candidate.ai_score_motivation|default(0), 'comment': candidate.ai_score_comments_motivation|default('Нет данных')},
                                {'icon': 'fa-chart-line', 'name': 'Стабильность', 'score': candidate.ai_score_stability|default(0), 'comment': candidate.ai_score_comments_stability|default('Нет данных')},
                                {'icon': 'fa-check-circle', 'name': 'Релевантность опыта', 'score': candidate.ai_score_experience_relevance|default(0), 'comment': candidate.ai_score_comments_experience_relevance|default('Нет данных')},
                                {'icon': 'fa-language', 'name': 'Языки', 'score': candidate.ai_score_language|default(0), 'comment': candidate.ai_score_comments_language|default('Нет данных')},
                                {'icon': 'fa-money-bill-wave', 'name': 'Зарплатные ожидания', 'score': candidate.ai_score_salary|default(0), 'comment': candidate.ai_score_comments_salary|default('Нет данных')}
                            ] %}
                            {% for cat in categories %}
                            {% set icon_class = 'green' if cat.score >= 70 else ('yellow' if cat.score >= 40 else 'red') %}
                            <div class="ai-category">
                                <span class="ai-category-icon {{ icon_class }}"><i class="fas {{ cat.icon }}"></i></span>
                                <div class="ai-category-content">
                                    <div class="ai-category-header-row">
                                        <span class="ai-category-name text-secondary">{{ cat.name }}</span>
                                        <span class="ai-category-score-badge {% if cat.score >= 70 %}green{% elif cat.score >= 40 %}yellow{% else %}red{% endif %}">{{ cat.score }}/100</span>
                                    </div>
                                    <p class="ai-category-comment text-secondary">{{ cat.comment }}</p>
                                                    </div>
                                                </div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Рекомендация AI -->
                        <div class="ai-recommendation mt-4">
                            <h5 class="mb-3">Рекомендация AI:</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-lightbulb me-2"></i>
                                {{ candidate.ai_recommendation }}
                            </div>
                            
                            <!-- Стоп-факторы -->
                            <div class="alert alert-danger mt-3">
                                <h6 class="alert-heading"><i class="fas fa-ban me-2"></i>Критические стоп-факторы:</h6>
                                <ul class="mb-0">
                                    {% for factor in candidate.ai_analysis_data.stop_factors %}
                                    <li>{{ factor }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            
                            <!-- Генерация ответов с помощью ИИ -->
                            <div class="alert alert-warning mt-3">
                                <h6 class="alert-heading"><i class="fas fa-robot me-2"></i>Обнаружены признаки генерации ответов с помощью ИИ!</h6>
                                {% set ai_probability = candidate.ai_answer_quality.ai_generation_probability|default(0) %}
                                <div class="progress mt-2 mb-2 progress-lg">
                                    <div class="progress-bar bg-warning" role="progressbar" 
                                         aria-valuenow="{{ ai_probability }}" aria-valuemin="0" aria-valuemax="100"
                                         {% if ai_probability > 0 %}style="width: {{ ai_probability }}%"{% else %}style="width: 0%"{% endif %}>
                                        {{ ai_probability }}%
                                                    </div>
                                                </div>
                                <p class="mb-0">Вероятность генерации ответов с помощью искусственного интеллекта: <strong>{{ ai_probability }}%</strong></p>
                                <p class="mb-0 mt-2"><small>Порог для стоп-фактора: 50%</small></p>
                            </div>
                            
                            <!-- Несоответствия данных -->
                            <div class="alert alert-warning mt-3">
                                <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Обнаружены несоответствия в данных:</h6>
                                <ul class="mb-0">
                                    {% for inconsistency in candidate.ai_data_consistency.inconsistencies %}
                                    <li>{{ inconsistency }}</li>
                                    {% endfor %}
                                </ul>
                                <div class="mt-2">
                                    <span class="badge bg-warning text-dark">Уровень серьезности: {{ candidate.ai_data_consistency.severity }}</span>
                                    <span class="badge bg-info">Уровень доверия: {{ candidate.ai_data_consistency.trust_score }}%</span>
                                                    </div>
                                                </div>
                            
                            <!-- Вопросы для интервью -->
                            <div class="card mt-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0 text-secondary"><i class="fas fa-question-circle me-2"></i>Рекомендуемые вопросы для интервью:</h6>
                                </div>
                                <div class="card-body">
                                    <ol class="mb-0">
                                        {% for question in candidate.ai_analysis_data.interview_questions %}
                                        <li>{{ question }}</li>
                                        {% endfor %}
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <!-- Примечания о несоответствии -->
                        {% if candidate.ai_mismatch_notes %}
                        <div class="ai-notes mt-4">
                            <h5 class="mb-3">Примечания о несоответствии:</h5>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                {{ candidate.ai_mismatch_notes }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                        <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        AI-анализ еще не выполнен
                        </div>
                    {% if candidate.resume_text %}
                    <div class="text-center mt-3">
                        <button id="startAnalysisBtn" class="btn btn-primary">
                            <i class="fas fa-robot me-2"></i>Запустить AI-анализ
                        </button>
                    </div>
                    {% else %}
                    <div class="text-center mt-3">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Для запуска анализа необходимо сначала обработать резюме
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
            </div>
        </div>
    </div>
    
        <!-- Ответы на вопросы анкеты -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Ответы на вопросы</h4>
                </div>
                <div class="card-body">
                    <!-- Базовая информация -->
                    <h5>Базовая информация</h5>
                    {% set translations = {
                        'location': 'Местоположение',
                        'experience_years': 'Опыт работы (лет)',
                        'education': 'Образование',
                        'desired_salary': 'Желаемая зарплата',
                        'gender': 'Пол'
                    } %}
                    {% set education_translations = {
                        '0': 'Не указан',
                        '1': 'Среднее',
                        '2': 'Среднее специальное',
                        '3': 'Высшее',
                        '4': 'Магистратура',
                        '5': 'Аспирантура',
                        '6': 'Ученая степень',
                        '7': 'Другое'
                    } %}
                    {% set gender_map = {'0': 'Не указан', '1': 'Мужской', '2': 'Женский', 'male': 'Мужской', 'female': 'Женский'} %}
                    <table class="table table-striped">
                        <tbody>
                            {% if candidate.base_answers %}
                                {% for question, answer in candidate.base_answers.items() %}
                                <tr>
                                    <td><strong>{{ translations.get(question, question) }}</strong></td>
                                    <td>
                                        {% if question == 'education' %}
                                            {{ education_translations.get(answer|string, answer) }}
                                        {% elif question == 'gender' %}
                                            {{ gender_map.get(answer|string, 'Не указан') }}
                                        {% else %}
                                            {{ answer }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="2">Нет данных</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    
                    <!-- Сопроводительное письмо -->
                    {% if candidate.cover_letter %}
                    <h5 class="mt-4">Сопроводительное письмо</h5>
                    <div class="p-3 border rounded bg-light mb-4">
                        {{ candidate.cover_letter | replace('\n', '<br>') | safe }}
                    </div>
                    {% endif %}
                    
                    <!-- Профессиональные вопросы -->
                    <h5 class="mt-4">Профессиональные вопросы</h5>
                    <table class="table table-striped">
                        <tbody>
                            {% if candidate.vacancy_answers %}
                            {% for question, answer in candidate.vacancy_answers.items() %}
                            <tr>
                                <td><strong>{{ question }}</strong></td>
                                <td>{{ answer }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="2">Нет данных</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    
                    <!-- Soft skills вопросы -->
                    <h5 class="mt-4">Вопросы на soft skills</h5>
                    <table class="table table-striped">
                        <tbody>
                            {% if candidate.soft_answers %}
                            {% for question, answer in candidate.soft_answers.items() %}
                            <tr>
                                <td><strong>{{ question }}</strong></td>
                                <td>{{ answer }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="2">Нет данных</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Резюме кандидата -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Резюме кандидата</h4>
                    <div class="btn-group">
                    {% if resume_file_url %}
                    <a href="{{ resume_file_url }}" class="btn btn-sm text-light" download>
                        <i class="fas fa-download me-1"></i>Скачать оригинал
                    </a>
                    {% endif %}
                        {% if candidate.resume_path %}
                        <button type="button" id="reprocessResumeBtn" class="btn text-light ms-2">
                            <i class="fas fa-sync-alt me-1"></i>Распознать текст
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Индикатор загрузки -->
                    <div id="resumeProcessingLoader" class="text-center my-3 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Распознавание текста</p>
                    </div>
                    
                    <div id="resumeTextContainer">
                        {% if candidate.resume_text %}
                        <div class="resume-text-box p-3 bg-light rounded border mb-3">
                            <pre class="mb-0">{{ candidate.resume_text | replace('```', '') | replace('`', '') }}</pre>
                    </div>
                    {% else %}
                        <div class="alert alert-warning">
                            Текст резюме не распознан. Нажмите кнопку "Распознать текст через OpenAI" для обработки.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Показ/скрытие поля для даты собеседования в зависимости от выбранного статуса
    document.addEventListener('DOMContentLoaded', function() {
        // Настройка статуса кандидата
        const statusBadge = document.getElementById('statusBadge');
        if (statusBadge) {
            const colorCode = statusBadge.style.backgroundColor;
            
            if (colorCode) {
                // Проверяем формат цветового кода и преобразуем его при необходимости
                let cssColor;
                
                // Если цвет в формате как #FF0000
                if (colorCode.startsWith('#')) {
                    cssColor = colorCode;
                }
                // Если цвет в шестнадцатеричном формате без символа #, как FF0000
                else if (/^[0-9A-Fa-f]{6}$/.test(colorCode)) {
                    cssColor = '#' + colorCode;
                }
                // Если цвет - предопределенное название из Bootstrap
                else if (['primary', 'secondary', 'success', 'danger', 'warning', 'info', 'light', 'dark'].includes(colorCode)) {
                    statusBadge.className = 'badge rounded-pill bg-' + colorCode;
                    return; // Выходим после установки класса
                }
                // Если не удалось определить формат, используем серый цвет
                else {
                    cssColor = '#6c757d'; // Bootstrap secondary color
                }
                
                // Устанавливаем цвет фона напрямую через стиль
                statusBadge.style.backgroundColor = cssColor;
                // Удаляем все bg-* классы
                statusBadge.className = 'badge rounded-pill';
            } else {
                // Если цвет не указан, используем стандартный серый
                statusBadge.style.backgroundColor = '#6c757d';
            }
        }
        
        // Поле даты интервью
        const statusSelect = document.querySelector('select[name="stage_id"]');
        const interviewDateContainer = document.getElementById('interviewDateContainer');
        
        // Проверяем начальное состояние
        if (statusSelect && interviewDateContainer) {
            checkInterviewStatus();
            
            // Добавляем обработчик события
            statusSelect.addEventListener('change', checkInterviewStatus);
            
            function checkInterviewStatus() {
                // ID статуса "Назначено интервью" = 2
                if (statusSelect.value == '2') {
                    interviewDateContainer.style.display = 'block';
                } else {
                    interviewDateContainer.style.display = 'none';
                }
            }
        }
        
        // Обработчик для кнопки повторной обработки резюме
        const reprocessBtn = document.getElementById('reprocessResumeBtn');
        if (reprocessBtn) {
            reprocessBtn.addEventListener('click', function() {
                if (!confirm('Вы уверены, что хотите повторно распознать текст резюме через OpenAI API? Это может занять некоторое время.')) {
                    return;
                }
                
                // Показываем индикатор загрузки
                document.getElementById('resumeProcessingLoader').classList.remove('d-none');
                reprocessBtn.disabled = true;
                
                // Отправляем запрос на обработку резюме
                fetch('{{ url_for("candidates.reprocess_resume", id=candidate.id) }}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Скрываем индикатор загрузки
                    document.getElementById('resumeProcessingLoader').classList.add('d-none');
                    reprocessBtn.disabled = false;
                    
                    if (data.status === 'success') {
                        // Обновляем текст резюме на странице
                        const resumeTextElement = document.getElementById('resumeTextContainer');
                        if (resumeTextElement) {
                            resumeTextElement.innerHTML = '<div class="resume-text-box p-3 bg-light rounded border mb-3"><pre class="mb-0">' + data.resume_text + '</pre></div>';
                        }
                        
                        // Показываем уведомление об успехе
                        showNotification('success', 'Резюме успешно обработано через OpenAI API');
                    } else {
                        // Показываем уведомление об ошибке
                        showNotification('error', data.message);
                    }
                })
                .catch(error => {
                    // Скрываем индикатор загрузки
                    document.getElementById('resumeProcessingLoader').classList.add('d-none');
                    reprocessBtn.disabled = false;
                    
                    // Показываем уведомление об ошибке
                    showNotification('error', 'Произошла ошибка при обработке запроса');
                    console.error('Error:', error);
                });
            });
        }
        
        // Обработчик для кнопки запуска AI-анализа
        const startAnalysisBtn = document.getElementById('startAnalysisBtn');
        if (startAnalysisBtn) {
            startAnalysisBtn.addEventListener('click', function() {
                // Показываем индикатор загрузки
                document.getElementById('aiLoadingSpinner').classList.remove('d-none');
                startAnalysisBtn.disabled = true;
                
                // Отправляем запрос на запуск анализа
                fetch('{{ url_for("candidates.start_analysis", id=candidate.id) }}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Скрываем индикатор загрузки
                    document.getElementById('aiLoadingSpinner').classList.add('d-none');
                    startAnalysisBtn.disabled = false;
                    
                    if (data.status === 'success') {
                        // Показываем уведомление об успехе
                        showNotification('success', data.message);
                        
                        // Перезагружаем страницу для отображения результатов
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        // Показываем уведомление об ошибке
                        showNotification('error', data.message);
                    }
                })
                .catch(error => {
                    // Скрываем индикатор загрузки
                    document.getElementById('aiLoadingSpinner').classList.add('d-none');
                    startAnalysisBtn.disabled = false;
                    
                    // Показываем уведомление об ошибке
                    showNotification('error', 'Произошла ошибка при запуске анализа');
                    console.error('Error:', error);
                });
            });
        }
        
        // Обработчик для кнопки повторного AI-анализа
        const rerunAnalysisBtn = document.getElementById('rerunAnalysisBtn');
        if (rerunAnalysisBtn) {
            rerunAnalysisBtn.addEventListener('click', function() {
                // Показываем индикатор загрузки
                document.getElementById('aiLoadingSpinner').classList.remove('d-none');
                rerunAnalysisBtn.disabled = true;
        
                // Отправляем запрос на запуск анализа
                fetch('{{ url_for("candidates.start_analysis", id=candidate.id) }}', {
            method: 'POST',
            headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
        .then(data => {
                    // Скрываем индикатор загрузки
                    document.getElementById('aiLoadingSpinner').classList.add('d-none');
                    rerunAnalysisBtn.disabled = false;
            
            if (data.status === 'success') {
                        // Показываем уведомление об успехе
                        showNotification('success', data.message);
                        
                        // Перезагружаем страницу для отображения результатов
                setTimeout(() => {
                    window.location.reload();
                        }, 1500);
            } else {
                        // Показываем уведомление об ошибке
                        showNotification('error', data.message);
            }
        })
        .catch(error => {
                    // Скрываем индикатор загрузки
                    document.getElementById('aiLoadingSpinner').classList.add('d-none');
                    rerunAnalysisBtn.disabled = false;
                    
                    // Показываем уведомление об ошибке
                    showNotification('error', 'Произошла ошибка при запуске анализа');
                    console.error('Error:', error);
                });
            });
        }
        
        // Функция для отображения уведомлений
        function showNotification(type, message) {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} notification`;
            notificationDiv.innerHTML = message;
            document.body.appendChild(notificationDiv);
            
            // Добавляем стили для уведомления
            notificationDiv.style.position = 'fixed';
            notificationDiv.style.top = '20px';
            notificationDiv.style.right = '20px';
            notificationDiv.style.zIndex = '9999';
            notificationDiv.style.minWidth = '300px';
            notificationDiv.style.padding = '15px';
            notificationDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
            
            // Удаляем уведомление через 3 секунды
            setTimeout(() => {
                notificationDiv.remove();
            }, 3000);
        }
    });
</script>
{% endblock %} 